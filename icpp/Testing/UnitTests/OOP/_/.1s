ѕерем стр∆урнал Ёкспорт;
ѕерем  онт‘ормы;

‘ункци€  онт( онт) ¬озврат  онт;  онец‘ункции // :  онтекст
‘ункци€ —ам() ¬озврат  онт( онтекст);  онец‘ункции // :  онтекст
‘ункци€ Ѕаза() ¬озврат  онт( онтекст).ѕолучитьЅазовый ласс();  онец‘ункции

ѕроцедура —брос() Ёкспорт
	≈сли “ип«начени€( онт‘ормы)=100 “огда
		 онт‘ормы.‘орма.«акрыть();
	 онец≈сли;

	Ѕаза().—брос(); // об€зательно !!
 онецѕроцедуры

ѕроцедура  омпил€ци€ћодул€ ласса() Ёкспорт
	—ам=—ам();
	ќбъект=—оздатьќбъект("“есты_ омпил€ци€ ласса");
	ќбъект.«аполнить‘лаги();
	—ам.ѕроверить–авенство(ќбъект.стр∆урнал, "Ёто ласс");
 онецѕроцедуры

‘ункци€ ѕолучить“ек онтекст()
	ѕерем  онт;     

	ѕопытка
		—ервис=—оздатьќбъект("—ервис");
	»сключение
		—ам().ѕропустить“ест(, "ƒл€ проверки необходимо загрузить FormEx");
	 онецѕопытки;
	
	—ервис.јктивный онтекст( онт);
	¬озврат  онт;
 онец‘ункции

ѕроцедура “ест_ омпил€ци€ћодул€ лассаЅезќтладки() Ёкспорт
	¬ключитьќтладку(0);
	 омпил€ци€ћодул€ ласса();
 онецѕроцедуры

ѕроцедура “ест_ омпил€ци€ћодул€ ласса—ќтладкой() Ёкспорт
	—ам=—ам();
	
	//—ообщить("Ќифига сообщени€ автоматом не занос€тс€ в лог-файл
	//		|а если в модуле класса определить процедуру —ообщить() как в глобальнике, все будет ок.
	//		|это недокументированна€ особенность недокументированного перехвата данной функции");
	
	тек онтекст=ѕолучить“ек онтекст();
	
	¬ключитьќтладку(1);
	 омпил€ци€ћодул€ ласса();
	
	 онтекстќтладки=ѕолучить“ек онтекст();
	—ам.ѕроверитьЌеравенство( онтекстќтладки, тек онтекст);

	—ам.ѕроверить–авенство( онтекстќтладки.стр опи€∆урнала, "ѕриќтладке");
 онецѕроцедуры

ѕроцедура  омпил€ци€ћодул€ќбработки() Ёкспорт
	—ам=—ам();
//	—ам.ѕропустить“ест(); //ѕадают тесты после тестов ¬ыполн€емогоћодул€
	
	ќткрыть‘орму("ќбработка#",  онт‘ормы, —ам.ѕолучитьѕуть());
	—ам.ѕроверить–авенство(“ип«начени€—тр( онт‘ормы), "√рупповой онтекст");

	 онт‘ормы.«аполнить‘лаги();
	—ам.ѕроверить–авенство( онт‘ормы.стр∆урнал, "ѕриќткрытииќбработки, Ётоќбработка");
 онецѕроцедуры

ѕроцедура “ест_ омпил€ци€ћодул€ќбработкиѕри¬ыключеннойќтладке() Ёкспорт
	¬ключитьќтладку(0);
	 омпил€ци€ћодул€ќбработки();
 онецѕроцедуры

ѕроцедура “ест_ омпил€ци€ћодул€ќбработкиѕри¬ключеннойќтладке() Ёкспорт
//ѕредупреждение(1);	
	¬ключитьќтладку(1);
	 омпил€ци€ћодул€ќбработки();
 онецѕроцедуры

ѕроцедура —оздать‘айл»зменчивого ласса(стр–езультат)
	»м€‘айла ласса=—тр«аменить(—ам().ѕолучитьѕуть(), "“есты_ омпил€ци€ ласса.ert", "»зменчивый ласс.txt");
	“екст=—оздатьќбъект("“екст");
	“екст.ƒобавить—троку("‘ункци€ ѕолучить«начение() Ёкспорт
			|	¬озврат """+стр–езультат+""";
			| онец‘ункции");
	“екст.«аписать(»м€‘айла ласса);
 онецѕроцедуры

ѕроцедура “ест_–ежимыќптимизации1() Ёкспорт
	—ам=—ам();
	¬ключитьќптимизацию(0);
	
	—оздать‘айл»зменчивого ласса("«начение1");
	ќбъект=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект.ѕолучить«начение(), "«начение1");
	
	—оздать‘айл»зменчивого ласса("«начение2");
	ќбъект=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект.ѕолучить«начение(), "«начение2");
	
	¬ключитьќптимизацию(1);
	
	—оздать‘айл»зменчивого ласса("«начение1");
	ќбъект=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект.ѕолучить«начение(), "«начение1");
	
	—оздать‘айл»зменчивого ласса("«начение2");
	ќбъект=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект.ѕолучить«начение(), "«начение1");
 онецѕроцедуры

ѕроцедура “ест_–ежимыќптимизации2() Ёкспорт
	—ам=—ам();
	
	¬ключитьќптимизацию(0);
	—оздать‘айл»зменчивого ласса("«начение1");
	ќбъект1=—оздатьќбъект("»зменчивый ласс");
	¬ключитьќптимизацию(1);
	—оздать‘айл»зменчивого ласса("«начение2");
	ќбъект2=—оздатьќбъект("»зменчивый ласс");
	
	—ам.ѕроверить–авенство(ќбъект1.ѕолучить«начение(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект2.ѕолучить«начение(), "«начение2");
	
	¬ключитьќптимизацию(0);
	ќбъект2=—оздатьќбъект("»зменчивый ласс");
	
	—ам.ѕроверить–авенство(ќбъект1.ѕолучить«начение(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект2.ѕолучить«начение(), "«начение2");
 онецѕроцедуры

ѕроцедура “ест_–ежимыќптимизации3() Ёкспорт
	—ам=—ам();
	
	—оздать‘айл»зменчивого ласса("«начение1");
	
	¬ключитьќптимизацию(0);
	ќбъект1=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект1.ѕолучить«начение(), "«начение1");
	¬ключитьќптимизацию(1);
	ќбъект2=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект2.ѕолучить«начение(), "«начение1");
	
	—оздать‘айл»зменчивого ласса("«начение2");
	¬ключитьќптимизацию(0);
	ќбъект2=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект1.ѕолучить«начение(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект2.ѕолучить«начение(), "«начение2");
	
	—оздать‘айл»зменчивого ласса("«начение1");
	¬ключитьќптимизацию(1);
	ќбъект2=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект1.ѕолучить«начение(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект2.ѕолучить«начение(), "«начение1");

	—оздать‘айл»зменчивого ласса("«начение2");
	ќбъект2=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект1.ѕолучить«начение(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект2.ѕолучить«начение(), "«начение1");
 онецѕроцедуры

ѕроцедура ƒобавить«апись¬∆урнал(»м€ћетода) Ёкспорт
	≈сли ѕустое«начение(стр∆урнал)=1 “огда
		стр∆урнал=»м€ћетода;
	»наче
		стр∆урнал=стр∆урнал+", "+»м€ћетода;
	 онец≈сли;
	//¬ принципе, конечно, можно оставить так. Ќо в строгих €зыках нужна условна€ компил€ци€.
	стр опи€∆урнала=стр∆урнал;
 онецѕроцедуры

ѕроцедура «аполнить‘лаги() Ёкспорт
//#if _NOW_PREPARE_CLASS
	ƒобавить«апись¬∆урнал("Ёто ласс");
//#else
	ƒобавить«апись¬∆урнал("Ётоќбработка");
//#endif
 онецѕроцедуры

ѕроцедура ѕриќткрытии()
//#if _NOW_PREPARE_CLASS
	‘орма.ѕараметр._ѕриќткрытии();
	ƒобавить«апись¬∆урнал("ѕриќтладке");
	//—ообщить("ѕриќткрытии");
	
//#else
	ƒобавить«апись¬∆урнал("ѕриќткрытииќбработки");
	
	// этот код нужен чтобы в режиме отладки класса обращатьс€ к методам и свойствам контекста данной формы в файле класса
	// уже не нужен
	//л”скоритель = —оздатьќбъект("”скоритель√ ");
	//л”скоритель.”скорить();

//#endif
 онецѕроцедуры

ѕроцедура “ест_ омпил€ци€—¬ключениемј«атемќтключениемќптимизации() Ёкспорт
	—ам=—ам();
	¬ключитьќптимизацию(1);
	
	—оздать‘айл»зменчивого ласса("«начение1");
	ќбъект=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект.ѕолучить«начение(), "«начение1");
	
	—оздать‘айл»зменчивого ласса("«начение2");
	ќбъект=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект.ѕолучить«начение(), "«начение1");
	
	ћета»нфо = —оздатьќбъект("MetaInfoClasses");
	ћета»нфо.ќчиститьƒанныеќптимизации лассов();
	//¬ключитьќптимизацию(0);
	
	—оздать‘айл»зменчивого ласса("«начение2");
	ќбъект=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект.ѕолучить«начение(), "«начение2");
	
	—оздать‘айл»зменчивого ласса("«начение1");
	ќбъект=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект.ѕолучить«начение(), "«начение2");
 онецѕроцедуры

ѕроцедура —оздать‘айл»зменчивого ласса—Ќовымћетодом»—войством(стр–езультат, Ќаименованиећетода)
	»м€‘айла ласса=—тр«аменить(—ам().ѕолучитьѕуть(), "“есты_ омпил€ци€ ласса.ert", "»зменчивый ласс.txt");
	“екст=—оздатьќбъект("“екст");
	
	“екст.ƒобавить—троку("ѕерем јтрибутћодул€"+Ќаименованиећетода+" Ёкспорт;");
			
	“екст.ƒобавить—троку("‘ункци€ ѕолучить«начение() Ёкспорт
			|	¬озврат """+стр–езультат+""";
			| онец‘ункции");

	“екст.ƒобавить—троку("‘ункци€ ћетод"+Ќаименованиећетода+"() Ёкспорт
			| јтрибутћодул€"+Ќаименованиећетода+" = """+Ќаименованиећетода+""";
			|	¬озврат """+стр–езультат+""";
			| онец‘ункции");
	
	“екст.«аписать(»м€‘айла ласса);
 онецѕроцедуры
                                                       
ѕроцедура ѕроверить омпил€цию—¬ключениемј«атем—бросомќптимизации()
	—ам=—ам();

	// схема следующа€ - все действи€ при включенном режиме оптимизации
	// 1) сначала создаю два разных объекта одного класса
	//		два класса нужны, чтобы убедитьс€ в правильности множественной реализации подсчета ссылок
	// 2) мен€ю код класса (добавл€ю новый метод и мен€ю значение)
	// 3) сбрасываю данные оптимизации классов                    
	// 4) создаю новый объект c другими методами и атрибутами
	// 5) теперь дл€ первых двух объектов (если сброс оптимизации работает верно)
	//		- не должно быть ни новых методов, ни новых атрибутов и все значени€ должны остатьс€ старыми
	
	—оздать‘айл»зменчивого ласса—Ќовымћетодом»—войством("«начение1", "1");

	¬ключитьќптимизацию(1);
	
	ќбъект1 = —оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект1.ѕолучить«начение(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект1.ћетод1(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект1.јтрибутћодул€1, "1");
	                                                       
	»нформатор = —оздатьќбъект("»нформатор");

	—ам.ѕроверить–авенство(»нформатор.ћетод—уществует(ќбъект1, "ћетод2"), 0);
	
	//—оздать‘айл»зменчивого ласса("«начение2");
	ќбъект2 = —оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект2.ѕолучить«начение(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект2.ћетод1(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект2.јтрибутћодул€1, "1");
	
	ћета»нфо = —оздатьќбъект("MetaInfoClasses");
	ћета»нфо.ќчиститьƒанныеќптимизации лассов();

	—оздать‘айл»зменчивого ласса—Ќовымћетодом»—войством("«начение2", "2");
	
	ќбъект=—оздатьќбъект("»зменчивый ласс");
	—ам.ѕроверить–авенство(ќбъект.ѕолучить«начение(), "«начение2");
	—ам.ѕроверить–авенство(ќбъект.ћетод2(), "«начение2");
	—ам.ѕроверить–авенство(ќбъект.јтрибутћодул€2, "2");

	—ам.ѕроверить–авенство(ќбъект1.ѕолучить«начение(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект1.ћетод1(), "«начение1");
	—ам.ѕроверить–авенство(»нформатор.ћетод—уществует(ќбъект1, "ћетод2"), 0);
	—ам.ѕроверить–авенство(ќбъект1.јтрибутћодул€1, "1");
	
	—ам.ѕроверить–авенство(ќбъект2.ѕолучить«начение(), "«начение1");
	—ам.ѕроверить–авенство(ќбъект2.ћетод1(), "«начение1");
	—ам.ѕроверить–авенство(»нформатор.ћетод—уществует(ќбъект2, "ћетод2"), 0);
	—ам.ѕроверить–авенство(ќбъект2.јтрибутћодул€1, "1");
 онецѕроцедуры	// ѕроверить омпил€цию—¬ключениемј«атем—бросомќптимизации

// дл€ одного класса можно очистить данные оптимизации одним из двух вариантов !
ѕроцедура “ест_ омпил€ци€—¬ключениемј«атемќтключениемќптимизации2() Ёкспорт
	// очистить данные оптимизации дл€ класса "»зменчивый ласс"
	¬ключитьќптимизацию(0);
	ќбъект1 = —оздатьќбъект("»зменчивый ласс");
	
	ѕроверить омпил€цию—¬ключениемј«атем—бросомќптимизации();
 онецѕроцедуры

ѕроцедура “ест_ омпил€ци€—¬ключениемј«атемќтключениемќптимизации3() Ёкспорт
	// очистить данные оптимизации дл€ всех классов
	ћета»нфо = —оздатьќбъект("MetaInfoClasses");
	ћета»нфо.ќчиститьƒанныеќптимизации лассов();

	ѕроверить омпил€цию—¬ключениемј«атем—бросомќптимизации();
 онецѕроцедуры

ѕроцедура “ест_ омпил€ци€ћодул€ ласса_¬‘айле¬нешнейќбработкиЅезЁлементов‘ормы_—ќтладкой() Ёкспорт
	—ам=—ам();
	
	ѕомощник—оздани€ ласса = —оздатьќбъект("ѕомощник—оздани€ ласса");        
	»м€Ќового ласса = ѕомощник—оздани€ ласса.ѕолучить—лучайное»м€Ќового ласса();
	
	—трокаќписани€ ласса = "class "+»м€Ќового ласса+" = ExtForms\ќтчетЅезЁлементов‘ормы.ert
	|{}";
	
	_ћета»нфо = —оздатьќбъект("MetaInfoClasses");	
	_ћета»нфо.«агрузитьќписание лассов(—трокаќписани€ ласса);
	
	¬ключитьќтладку(1);

	ќбъект = —оздатьќбъект(»м€Ќового ласса);
	—ам.ѕроверить“ип«начени€(ќбъект, »м€Ќового ласса);
	ќбъект.ћетод();
 онецѕроцедуры

ѕроцедура “ест_ омпил€ци€ћодул€ ласса_¬“екстовом‘айле_—ќтладкой() Ёкспорт
	—ам=—ам();
	
	»м€Ќового ласса = "ќќѕѕредок";

	¬ключитьќтладку(1);

	ќбъект = —оздатьќбъект(»м€Ќового ласса);
	—ам.ѕроверить“ип«начени€(ќбъект, »м€Ќового ласса);
 онецѕроцедуры
